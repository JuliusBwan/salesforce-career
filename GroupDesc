public class GroupDesc {

    public final String originalName;
    public final Date startDate;
    public final Date endDate;

    private GroupDesc(String name, Date start, Date end) {
        originalName = name;
        startDate = start;
        endDate = end;
    }

    // Build from an original quote line group
    // If end date is missing, compute it from subscription term (months)
    public static GroupDesc fromGroup(
        SBQQ__QuoteLineGroup__c g,
        Integer subscriptionTerm
    ) {
        Date computedEnd = g.SBQQ__EndDate__c;

        if (computedEnd == null &&
            subscriptionTerm != null &&
            g.SBQQ__StartDate__c != null) {
            computedEnd = g.SBQQ__StartDate__c.addMonths(subscriptionTerm);
        }

        return new GroupDesc(
            g.Name,
            g.SBQQ__StartDate__c,
            computedEnd
        );
    }

    // Derive group ONLY if an original group exists
    // No fallback / date-only group creation
    public static GroupDesc derive(
        SBQQ__QuoteLine__c renewalLine,
        RenewalContext ctx
    ) {
        SBQQ__Subscription__c sub =
            ctx.subsById.get(renewalLine.SBQQ__RenewedSubscription__c);

        if (sub == null || sub.SBQQ__QuoteLine__c == null) {
            return null;
        }

        SBQQ__QuoteLine__c originalLine =
            ctx.oqlById.get(sub.SBQQ__QuoteLine__c);

        if (originalLine == null || originalLine.SBQQ__Group__c == null) {
            return null;
        }

        SBQQ__QuoteLineGroup__c originalGroup =
            ctx.origGroupsById.get(originalLine.SBQQ__Group__c);

        if (originalGroup == null) {
            return null;
        }

        return fromGroup(
            originalGroup,
            originalLine.Subscription_Term__c
        );
    }

    // Used to dedupe groups
    public String fingerprint() {
        return String.valueOf(startDate) + '|' + String.valueOf(endDate);
    }

    // <Original Group Name> : Jan 2025 – Dec 2025
    public String defaultName() {
        String startLabel = startDate.format('MMM yyyy');
        String endLabel   = endDate != null ? endDate.format('MMM yyyy') : 'Open';

        return originalName + ' : ' + startLabel + ' – ' + endLabel;
    }
}
